## 서론

테스트 환경을 만드는 과정에서 중요한 부분 중 하나는 멱등성을 지키는 것이다.

멱등성을 지키지 않는다면 다른 테스트나 외부 모듈로 인해 예상치 못한 상황에서 테스트가 실패할 수 있고, 실패한 곳을 찾는 게 힘들어지게 된다.

<br>

그렇다면 DB를 사용하는 통합 테스트를 진행할 때, DB를 통제해서 멱등성을 지키는 테스트 환경을 만드는 방법에는 어떤 것들이 있을까?

## DB를 통제하는 방법

### 로컬에서 테스트 전용 DB 사용

- 운영 환경과 동일하지만 독립적인 별도의 테스트 전용 DB를 사용하는 방법이다.
- 테스트 중에 발생하는 변경 사항이 실제 데이터에 영향을 미치지 않게 할 수 있다.

<br>

단점은 다음과 같다.

- 테스트를 하려고 하는 환경마다 DB를 설치하고 환경을 구축해야 한다.
- 운영 환경과 같은 환경을 유지해야 하기 때문에 스키마 변경 등의 작업이 발생할 때 마다 테스트 DB도 같이 수정해줘야 한다.

### 원격 서버에 있는 DB 사용

- 테스트를 하려고 하는 환경이 아니라 외부의 원격 서버에 DB를 두는 방법이다.
- 로컬에 직접 환경을 구축하지 않아도 되게 된다.

<br>

단점은 다음과 같다.

- 원격 서버에 의존하기 때문에 네트워크 연결이 필수적이게 된다.
- 여러 개발자가 동시에 테스트 진행 시 멱등성이 깨질 수 있다.
    - ex) 한 개발자가 특정 레코드를 삭제하는 작업을 수행할 때 다른 개발자가 동시에 그 레코드에 대한 조회나 수정 작업을 수행하는 경우

### in-memory DB 사용

- H2 같은 in-memory DB를 사용하는 방법이다.
- 네트워크 연결이 필요하지 않다.
- 데이터를 디스크에 저장하는게 아니라 메모리에 저장하고 처리하기 때문에 빠르다.

<br>

단점은 다음과 같다.

- 운영 환경에서 사용하는 DB와 in-memory DB와의 문법 차이 때문에 운영 환경에서 사용하는 SQL이 동작하지 않을 수 있다.

### TestContainer 사용

- Docker 컨테이너를 이용해 테스트 환경을 구축하는 방법이다.
- 외부 설정 없이 자바 코드만으로 Docker 컨테이너를 통한 테스트 환경을 구축할 수 있다.
- 각 테스트가 독립적인 컨테이너 내부에서 실행되기 때문에 다른 테스트와 완전히 격리되어 멱등성을 보장한다.

<br>

단점은 다음과 같다.

- Docker가 설치되어 있어야 한다.
- Docker 컨테이너의 시작과 종료에 시간이 소요되기 때문에 테스트 수행 시간이 증가할 수 있다.

## 결론

DB를 통제하는 각 방법에 장단점이 있지만, 멱등성을 보장해 테스트의 신뢰성을 높일 수 있는 TestContainer를 사용하는 것이 가장 좋다고 생각한다.
